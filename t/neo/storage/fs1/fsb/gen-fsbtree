#!/bin/sh -e
# generate b.Tree with compile-time KEY=zodb.Oid, VALUE=int64 and direct oidCmp calls

KEY=zodb.Oid
VALUE=int64

b=github.com/cznic/b
Bdir=`go list -f '{{.Dir}}' $b`
Brev=`cd $Bdir && git describe --always`
out=fsbtree.go

echo "// DO NOT EDIT - AUTOGENERATED (by gen-fsbtree from $b $Brev)" >$out
echo "// KEY=$KEY  VALUE=$VALUE" >>$out
echo "// ---- 8< ----" >>$out
echo >>$out
make -s -C $Bdir generic |sed	\
	-e '/package b/a \\nimport "../../../zodb"'	\
	-e 's/package b/package fsb/g'	\
	-e "s/KEY/$KEY/g"	\
	-e "s/VALUE/$VALUE/g"	\
 \
	-e '/cmp *Cmp$/d'	\
	-e 's/t\.cmp(/oidCmp(/g'	\
	-e 's/func TreeNew(cmp Cmp)/func TreeNew()/g'	\
	-e 's/btTPool.get(cmp)/btTPool.get()/g'	\
	-e 's/func (p \*btTpool) get(cmp Cmp)/func (p *btTpool) get()/g'	\
	-e '/x\.cmp = cmp$/d'	\
	>>$out
